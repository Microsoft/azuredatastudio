steps:
- task: NodeTool@0
  inputs:
    versionSpec: '10.15.1'
  displayName: 'Install Node.js'

- task: CacheBeta@0
  inputs:
    key: yarn3 | $(Agent.OS) | .yarnrc | remote/.yarnrc | **/yarn.lock, !**/node_modules/**/yarn.lock, !**/.*/**/yarn.lock'
    path: $(Agent.TempDirectory)/tmp_cache.tar.gz
    cacheHitVar: CACHE_RESTORED
  displayName: Cache Yarn packages

- task: ExtractFiles@1
  inputs:
    archiveFilePatterns: '$(Agent.TempDirectory)/tmp_cache.tar.gz'
    destinationFolder: '$(Build.SourcesDirectory)'
  displayName: Untaring cache
  condition: eq(variables['CACHE_RESTORED'], true)

- script: |
    yarn --frozen-lockfile --cache-folder $(YARN_CACHE_FOLDER)
  displayName: Install Dependencies

- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: 'node_modules'
    includeRootFolder: true
    archiveType: 'tar'
    tarCompression: 'gz'
    archiveFile: $(Agent.TempDirectory)/tmp_cache.tar.gz
  displayName: Tar cache
  condition: ne(variables['CACHE_RESTORED'], true)

- script: |
    yarn gulp electron-x64
  displayName: 'Electron'

- script: |
    yarn gulp hygiene
  displayName: Run Hygiene Checks

- script: |
    yarn tslint
  displayName: 'Run TSLint'

- script: |
    yarn strict-null-check
  displayName: 'Run Strict Null Check'

- script: |
    yarn compile
  displayName: 'Compile'

- script: |
    .\scripts\test.bat --reporter mocha-junit-reporter --coverage
  displayName: 'Test'

- task: PublishTestResults@2
  inputs:
    testResultsFiles: 'test-results.xml'
  condition: succeededOrFailed()

- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: 'cobertura'
    summaryFileLocation: $(System.DefaultWorkingDirectory)\.build\coverage\cobertura-coverage.xml
    reportDirectory: $(System.DefaultWorkingDirectory)\.build\coverage\lcov-report
